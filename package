#!/bin/sh -e

BUILD=build
version=$(cat VERSION)
architecture=amd64

rm -Rf ${BUILD}
mkdir -p ${BUILD}/release ${BUILD}/tmp
cp -R deb/* ${BUILD}/tmp

echo "Building version $version..."

GOOS=linux GOARCH=${architecture} go build -o ${BUILD}/tmp/usr/bin/delauncher main.go

size=$(du -csh ${BUILD}/tmp | sed '1!d' | grep -oe "^[0-9]*")
sed -i 's/{{version}}/'${version}'/g;s/{{size}}/'${size}'/g;s/{{architecture}}/'${architecture}'/g' ${BUILD}/tmp/DEBIAN/control

fakeroot dpkg-deb -b -z9 ${BUILD}/tmp ${BUILD}/release

echo done